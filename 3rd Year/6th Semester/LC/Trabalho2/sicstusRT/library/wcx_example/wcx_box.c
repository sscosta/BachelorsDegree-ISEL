/* This is a sample WCX box supporting four external encodings: `latin1',
   `latin2', `unicode' and `euc'.

   The character code set uses character codes up to 24 bit wide:

      0 =< code =< 2^16-1    	A UNICODE character with the given code,
				   including ASCII.

      code = 2^16 + euc_code	A non-ASCII EUC character with code
				   `euc_code' 

   The four external encodings supported by the sample WCX box can be
   specified on a stream-by-stream basis, by supplying a `wcx(ENC)' option
   to `open/4', where `ENC' is one of the atoms latin1, latin2, unicode or
   euc.

   The mapping of these external encodings to the composite character code set
   is done in the following way:

      latin1   is mapped one-to-one to UNICODE codes 0x0..0xff

      latin2   is mapped to UNICODE codes 0x0..0x02dd, using an appropriate
	       conversion table for the non-ASCII part.

      unicode  assumes UTF-8 external encoding and maps one-to-one to the
	       0x0..0xffff UNICODE range.

      euc      assumes EUC external encoding and maps sub-codeset 0 to
	       UNICODE range 0x0..0x7f, and sub-codesets 1-3 to internal codes
	       above 0xffff, as shown above.  */

#include <sicstus/sicstus.h>
#include <stdio.h>
#include <stdlib.h>

#if _MSC_VER                    /* Win32 platform (MS C compiler) */
#include <string.h>
#define strcasecmp _stricmp
#else
#include <strings.h>            /* UNIX98: strcasecmp() */
#endif

/* generated by splfr from foreign declarations in wcx_box.pl */
#include "wcx_box_glue.h"

/* Conversion table for mapping latin2 characters >= 0xa0 to unicode */

#define MIN_LATIN2 0xa0
#define MAX_LATIN2 0xff

short latin2_unicode[] = {
0x00A0, /* <NS>  /xA0  <U00A0>  NO-BREAK SPACE                               */
0x0104, /* <A;>  /xA1  <U0104>  LATIN CAPITAL LETTER A WITH OGONEK	     */
0x02D8, /* <'(>  /xA2  <U02D8>  BREVE					     */
0x0141, /* <L/>  /xA3  <U0141>  LATIN CAPITAL LETTER L WITH STROKE	     */
0x00A4, /* <Cu>  /xA4  <U00A4>  CURRENCY SIGN				     */
0x013D, /* <L<>  /xA5  <U013D>  LATIN CAPITAL LETTER L WITH CARON	     */
0x015A, /* <S'>  /xA6  <U015A>  LATIN CAPITAL LETTER S WITH ACUTE	     */
0x00A7, /* <SE>  /xA7  <U00A7>  SECTION SIGN				     */
0x00A8, /* <':>  /xA8  <U00A8>  DIAERESIS				     */
0x0160, /* <S<>  /xA9  <U0160>  LATIN CAPITAL LETTER S WITH CARON	     */
0x015E, /* <S,>  /xAA  <U015E>  LATIN CAPITAL LETTER S WITH CEDILLA	     */
0x0164, /* <T<>  /xAB  <U0164>  LATIN CAPITAL LETTER T WITH CARON	     */
0x0179, /* <Z'>  /xAC  <U0179>  LATIN CAPITAL LETTER Z WITH ACUTE	     */
0x00AD, /* <-->  /xAD  <U00AD>  SOFT HYPHEN				     */
0x017D, /* <Z<>  /xAE  <U017D>  LATIN CAPITAL LETTER Z WITH CARON	     */
0x017B, /* <Z.>  /xAF  <U017B>  LATIN CAPITAL LETTER Z WITH DOT ABOVE	     */
0x00B0, /* <DG>  /xB0  <U00B0>  DEGREE SIGN				     */
0x0105, /* <a;>  /xB1  <U0105>  LATIN SMALL LETTER A WITH OGONEK	     */
0x02DB, /* <';>  /xB2  <U02DB>  OGONEK					     */
0x0142, /* <l/>  /xB3  <U0142>  LATIN SMALL LETTER L WITH STROKE	     */
0x00B4, /* <''>  /xB4  <U00B4>  ACUTE ACCENT				     */
0x013E, /* <l<>  /xB5  <U013E>  LATIN SMALL LETTER L WITH CARON		     */
0x015B, /* <s'>  /xB6  <U015B>  LATIN SMALL LETTER S WITH ACUTE		     */
0x02C7, /* <'<>  /xB7  <U02C7>  CARON (Mandarin Chinese third tone)	     */
0x00B8, /* <',>  /xB8  <U00B8>  CEDILLA					     */
0x0161, /* <s<>  /xB9  <U0161>  LATIN SMALL LETTER S WITH CARON		     */
0x015F, /* <s,>  /xBA  <U015F>  LATIN SMALL LETTER S WITH CEDILLA	     */
0x0165, /* <t<>  /xBB  <U0165>  LATIN SMALL LETTER T WITH CARON		     */
0x017A, /* <z'>  /xBC  <U017A>  LATIN SMALL LETTER Z WITH ACUTE		     */
0x02DD, /* <'">  /xBD  <U02DD>  DOUBLE ACUTE ACCENT			     */
0x017E, /* <z<>  /xBE  <U017E>  LATIN SMALL LETTER Z WITH CARON		     */
0x017C, /* <z.>  /xBF  <U017C>  LATIN SMALL LETTER Z WITH DOT ABOVE	     */
0x0154, /* <R'>  /xC0  <U0154>  LATIN CAPITAL LETTER R WITH ACUTE	     */
0x00C1, /* <A'>  /xC1  <U00C1>  LATIN CAPITAL LETTER A WITH ACUTE	     */
0x00C2, /* <A>>  /xC2  <U00C2>  LATIN CAPITAL LETTER A WITH CIRCUMFLEX	     */
0x0102, /* <A(>  /xC3  <U0102>  LATIN CAPITAL LETTER A WITH BREVE	     */
0x00C4, /* <A:>  /xC4  <U00C4>  LATIN CAPITAL LETTER A WITH DIAERESIS	     */
0x0139, /* <L'>  /xC5  <U0139>  LATIN CAPITAL LETTER L WITH ACUTE	     */
0x0106, /* <C'>  /xC6  <U0106>  LATIN CAPITAL LETTER C WITH ACUTE	     */
0x00C7, /* <C,>  /xC7  <U00C7>  LATIN CAPITAL LETTER C WITH CEDILLA	     */
0x010C, /* <C<>  /xC8  <U010C>  LATIN CAPITAL LETTER C WITH CARON	     */
0x00C9, /* <E'>  /xC9  <U00C9>  LATIN CAPITAL LETTER E WITH ACUTE	     */
0x0118, /* <E;>  /xCA  <U0118>  LATIN CAPITAL LETTER E WITH OGONEK	     */
0x00CB, /* <E:>  /xCB  <U00CB>  LATIN CAPITAL LETTER E WITH DIAERESIS	     */
0x011A, /* <E<>  /xCC  <U011A>  LATIN CAPITAL LETTER E WITH CARON	     */
0x00CD, /* <I'>  /xCD  <U00CD>  LATIN CAPITAL LETTER I WITH ACUTE	     */
0x00CE, /* <I>>  /xCE  <U00CE>  LATIN CAPITAL LETTER I WITH CIRCUMFLEX	     */
0x010E, /* <D<>  /xCF  <U010E>  LATIN CAPITAL LETTER D WITH CARON	     */
0x0110, /* <D/>  /xD0  <U0110>  LATIN CAPITAL LETTER D WITH STROKE	     */
0x0143, /* <N'>  /xD1  <U0143>  LATIN CAPITAL LETTER N WITH ACUTE	     */
0x0147, /* <N<>  /xD2  <U0147>  LATIN CAPITAL LETTER N WITH CARON	     */
0x00D3, /* <O'>  /xD3  <U00D3>  LATIN CAPITAL LETTER O WITH ACUTE	     */
0x00D4, /* <O>>  /xD4  <U00D4>  LATIN CAPITAL LETTER O WITH CIRCUMFLEX	     */
0x0150, /* <O">  /xD5  <U0150>  LATIN CAPITAL LETTER O WITH DOUBLE ACUTE     */
0x00D6, /* <O:>  /xD6  <U00D6>  LATIN CAPITAL LETTER O WITH DIAERESIS	     */
0x00D7, /* <*X>  /xD7  <U00D7>  MULTIPLICATION SIGN			     */
0x0158, /* <R<>  /xD8  <U0158>  LATIN CAPITAL LETTER R WITH CARON	     */
0x016E, /* <U0>  /xD9  <U016E>  LATIN CAPITAL LETTER U WITH RING ABOVE	     */
0x00DA, /* <U'>  /xDA  <U00DA>  LATIN CAPITAL LETTER U WITH ACUTE	     */
0x0170, /* <U">  /xDB  <U0170>  LATIN CAPITAL LETTER U WITH DOUBLE ACUTE     */
0x00DC, /* <U:>  /xDC  <U00DC>  LATIN CAPITAL LETTER U WITH DIAERESIS	     */
0x00DD, /* <Y'>  /xDD  <U00DD>  LATIN CAPITAL LETTER Y WITH ACUTE	     */
0x0162, /* <T,>  /xDE  <U0162>  LATIN CAPITAL LETTER T WITH CEDILLA	     */
0x00DF, /* <ss>  /xDF  <U00DF>  LATIN SMALL LETTER SHARP S (German)	     */
0x0155, /* <r'>  /xE0  <U0155>  LATIN SMALL LETTER R WITH ACUTE		     */
0x00E1, /* <a'>  /xE1  <U00E1>  LATIN SMALL LETTER A WITH ACUTE		     */
0x00E2, /* <a>>  /xE2  <U00E2>  LATIN SMALL LETTER A WITH CIRCUMFLEX	     */
0x0103, /* <a(>  /xE3  <U0103>  LATIN SMALL LETTER A WITH BREVE		     */
0x00E4, /* <a:>  /xE4  <U00E4>  LATIN SMALL LETTER A WITH DIAERESIS	     */
0x013A, /* <l'>  /xE5  <U013A>  LATIN SMALL LETTER L WITH ACUTE		     */
0x0107, /* <c'>  /xE6  <U0107>  LATIN SMALL LETTER C WITH ACUTE		     */
0x00E7, /* <c,>  /xE7  <U00E7>  LATIN SMALL LETTER C WITH CEDILLA	     */
0x010D, /* <c<>  /xE8  <U010D>  LATIN SMALL LETTER C WITH CARON		     */
0x00E9, /* <e'>  /xE9  <U00E9>  LATIN SMALL LETTER E WITH ACUTE		     */
0x0119, /* <e;>  /xEA  <U0119>  LATIN SMALL LETTER E WITH OGONEK	     */
0x00EB, /* <e:>  /xEB  <U00EB>  LATIN SMALL LETTER E WITH DIAERESIS	     */
0x011B, /* <e<>  /xEC  <U011B>  LATIN SMALL LETTER E WITH CARON		     */
0x00ED, /* <i'>  /xED  <U00ED>  LATIN SMALL LETTER I WITH ACUTE		     */
0x00EE, /* <i>>  /xEE  <U00EE>  LATIN SMALL LETTER I WITH CIRCUMFLEX	     */
0x010F, /* <d<>  /xEF  <U010F>  LATIN SMALL LETTER D WITH CARON		     */
0x0111, /* <d/>  /xF0  <U0111>  LATIN SMALL LETTER D WITH STROKE	     */
0x0144, /* <n'>  /xF1  <U0144>  LATIN SMALL LETTER N WITH ACUTE		     */
0x0148, /* <n<>  /xF2  <U0148>  LATIN SMALL LETTER N WITH CARON		     */
0x00F3, /* <o'>  /xF3  <U00F3>  LATIN SMALL LETTER O WITH ACUTE		     */
0x00F4, /* <o>>  /xF4  <U00F4>  LATIN SMALL LETTER O WITH CIRCUMFLEX	     */
0x0151, /* <o">  /xF5  <U0151>  LATIN SMALL LETTER O WITH DOUBLE ACUTE	     */
0x00F6, /* <o:>  /xF6  <U00F6>  LATIN SMALL LETTER O WITH DIAERESIS	     */
0x00F7, /* <-:>  /xF7  <U00F7>  DIVISION SIGN				     */
0x0159, /* <r<>  /xF8  <U0159>  LATIN SMALL LETTER R WITH CARON		     */
0x016F, /* <u0>  /xF9  <U016F>  LATIN SMALL LETTER U WITH RING ABOVE	     */
0x00FA, /* <u'>  /xFA  <U00FA>  LATIN SMALL LETTER U WITH ACUTE		     */
0x0171, /* <u">  /xFB  <U0171>  LATIN SMALL LETTER U WITH DOUBLE ACUTE	     */
0x00FC, /* <u:>  /xFC  <U00FC>  LATIN SMALL LETTER U WITH DIAERESIS	     */
0x00FD, /* <y'>  /xFD  <U00FD>  LATIN SMALL LETTER Y WITH ACUTE		     */
0x0163, /* <t,>  /xFE  <U0163>  LATIN SMALL LETTER T WITH CEDILLA	     */
0x02D9  /* <'.>  /xFF  <U02D9>  DOT ABOVE (Mandarin Chinese light tone)	     */
};

#define MAX_LATIN2_U 0x2dd
#define MIN_LATIN2_U 0x0a0

/* Conversion table for mapping unicode characters to latin2, generated at
   initialisation */
unsigned char unicode_latin2[MAX_LATIN2_U-MIN_LATIN2_U+1];



static int SPCDECL my_latin2_getc(int first_byte, SP_stream *stream, long *pbyte_count)
{
  if (first_byte < MIN_LATIN2)
    return first_byte;
  else
    return latin2_unicode[first_byte-MIN_LATIN2];
}

SP_WcxGetcHook *sp_euc_getc;  /* cache of SP_wcx_getc(WCX_USE_EUC) */

static int SPCDECL my_euc_getc(int byte, SP_stream *stream, long *pbyte_count)
{
  int euc_code = (*sp_euc_getc)(byte, stream, pbyte_count);
  if (euc_code < 0x80)
    return euc_code;
  else
    return 0x10000+euc_code;
}

static int SPCDECL my_latin2_putc(int ch, SP_stream *stream, long *pbyte_count)
{
  if (ch > MAX_LATIN2_U)
    return -1; /* ERROR */
  if (ch >= MIN_LATIN2_U)
    {
      ch = unicode_latin2[ch-MIN_LATIN2_U];
      if (ch == 0)
	return -1;
    }
  (*pbyte_count)++;
  return (stream->sputc)(ch,stream->user_handle);
}

SP_WcxPutcHook *sp_unicode_putc;  /* cache of SP_wcx_putc(WCX_USE_UTF8) */

static int SPCDECL my_unicode_putc(int ch, SP_stream *stream, long *pbyte_count)
{
  if (ch > 0xffff)
    return -1; /* ERROR */
  return (*sp_unicode_putc)(ch, stream, pbyte_count);
}

SP_WcxPutcHook *sp_euc_putc;  /* cache of SP_wcx_putc(WCX_USE_EUC) */

static int SPCDECL my_euc_putc(int ch, SP_stream *stream, long *pbyte_count)
{
  if (ch <= 0x7f)
    {
      (*pbyte_count)++;
      return (stream->sputc)(ch,stream->user_handle);
    }
  else if (ch >= 0x10000)
    return (*sp_euc_putc)(ch-0x10000, stream, pbyte_count);
  else
    return -1; /* ERROR */
}

static int env_encoding;

#define DEFAULT 0
#define LATIN1 1
#define LATIN2 2
#define UNICODE 3
#define EUC 4
#define LAST_ENC 4

static unsigned long int enc_atom[LAST_ENC+1];

char *enc_string[] = {"[]", "latin1", "latin2", "unicode", "euc"};

SP_WcxGetcHook *my_getc[] = {NULL, 
			     NULL, /* will be = SP_wcx_getc[WCX_USE_LATIN1] */
			     my_latin2_getc, 
			     NULL, /* will be = SP_wcx_getc[WCX_USE_UTF8] */
			     my_euc_getc};

SP_WcxPutcHook *my_putc[] = {NULL, 
			     NULL, /* will be = SP_wcx_putc[WCX_USE_LATIN1] */
			     my_latin2_putc,
			     my_unicode_putc, 
			     my_euc_putc};

void my_wcx_set_encoding(stream, opta)
SP_stream *stream;
unsigned long opta;
{
      int opt;

      for (opt = 0; opt <= LAST_ENC; opt++)
	if (opta == enc_atom[opt])
	  break;
      if (opt == 0)
	opt = env_encoding;
      if (opt > LAST_ENC)
	opt = LATIN1,
	  fprintf(stderr, "* WCX: Unrecognised encoding option %s, assuming latin1\n", 
		  SP_string_from_atom(opta));

      stream->wcx_getc = my_getc[opt];
      stream->wcx_putc = my_putc[opt];
}

static SP_stream *stream_from_code(long stream_code)
{
  void *stream_addr;
  SP_term_ref stream_ref = SP_new_term_ref();

  SP_put_integer(stream_ref, stream_code);
  SP_get_address(stream_ref, &stream_addr);

  return (SP_stream*)stream_addr;
}

static void SPCDECL my_wcx_open(SP_stream *stream, SP_atom option_atom, int where)
{
  (void)where;

  my_wcx_set_encoding(stream, option_atom);
}

void SPCDECL wcx_set_encoding(long stream_code, SP_atom option_atom)
{  
  my_wcx_set_encoding(stream_from_code(stream_code), option_atom);
}

static int SPCDECL my_wcx_chartype(int code)
{
  if (code >= 0x100)
    return CHT_SMALL_LETTER;
  else if (code == 0xA1) /* inverted exclamation mark, as an example of overriding
			   SP_latin1_chartype */
    return CHT_SOLO_CHAR;
  else
    return SP_latin1_chartype(code);
}

static void wcx_setup(void)
{
  int i;
  char *ctype = getenv("WCX_TYPE");
  env_encoding = LATIN1;

  /* set up default encoding from the  environment variable WCX_TYPE */

  if (ctype!=NULL)
    {
      for (i=1; i <= LAST_ENC; i++)
	if (strcasecmp(ctype, enc_string[i]) == 0)
	  break;
      if (i > LAST_ENC)
	fprintf(stderr, "* WCX: unknown WCX_TYPE value %s, using latin1\n",
		  ctype);
      else
	env_encoding = i;
    }
  
  /* get hold of useful conversion functions from SICStus WCX proper */

  my_getc[LATIN1] = SP_wcx_getc(WCX_USE_LATIN1);
  my_putc[LATIN1] = SP_wcx_putc(WCX_USE_LATIN1);
  my_getc[UNICODE] = SP_wcx_getc(WCX_USE_UTF8);
  sp_unicode_putc = SP_wcx_putc(WCX_USE_UTF8);
  sp_euc_getc = SP_wcx_getc(WCX_USE_EUC);
  sp_euc_putc = SP_wcx_putc(WCX_USE_EUC);

  SP_set_wcx_hooks(0,
		   my_wcx_open,
		   NULL,
		   my_wcx_chartype,
		   NULL,
		   NULL);

  /* initialize the conversion table for unicode-latin2 conversion */
  for (i= 0; i<=MAX_LATIN2_U-MIN_LATIN2_U; i++)
    unicode_latin2[i]=0;    /* error */
  for (i= 0; i<=MAX_LATIN2-MIN_LATIN2; i++)
    unicode_latin2[latin2_unicode[i]-MIN_LATIN2_U] = i+MIN_LATIN2;
}

void wcx_init_atoms()
{
  int i, rc;
  SP_term_ref arg1 = SP_new_term_ref(), 
              arg2 = SP_new_term_ref(), 
              arg3 = SP_new_term_ref();
  SP_pred_ref pred;

  for (i=0; i <= LAST_ENC; i++)
    {
      enc_atom[i] = SP_atom_from_string(enc_string[i]);
      SP_register_atom(enc_atom[i]);
    }
  
  /* Look up prolog_flag/3. */
  if (!(pred = SP_predicate("prolog_flag",3,"")))
    {
      fprintf(stderr, "Could not find prolog_flag/3.\n");
      exit(1);
    }
     
  /* Create the three arguments to prolog_flag/3. */

  SP_put_string(arg1, "wcx");
  SP_put_variable(arg2);
  SP_put_atom(arg3, enc_atom[env_encoding]);

  if ((rc=SP_query_cut_fail(pred, arg1, arg2, arg3)) != SP_SUCCESS)
    {
      fprintf(stderr, "call to prolog_flag failed, returned %d.\n", rc);
      exit(1);
    }  
}

void SPCDECL wcx_init(int when)
{
  (void)when;                   /* unused */

  wcx_setup();
  wcx_init_atoms();
}

void SPCDECL wcx_deinit(int when)
{
  /* [PM] 3.9b5 uninstall hooks so SP does not ever try to call
     functions from an unloaded foreign resource */
  SP_set_wcx_hooks(0,
		   NULL,
		   NULL,
		   NULL,
		   NULL,
		   NULL);
  /* Should really unregister atoms here but that is no big issue */
}
